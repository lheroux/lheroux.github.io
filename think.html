<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>think</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 20px;
      font-family: "Times New Roman", serif;
      background: #f5f5f0;
      color: #2c2c2c;
      line-height: 1.6;
      font-size: 14px;
    }
    #game-wrapper {
      display: flex;
      gap: 80px;
      max-width: 1100px;
      margin: 0 auto;
      justify-content: center;
    }
    #main-content { width: 600px; flex-shrink: 0; position: relative; }
    #story-container { width: 280px; flex-shrink: 0; }
    .clickable { cursor: pointer; user-select: none; display: inline; -webkit-tap-highlight-color: transparent; touch-action: manipulation; transition: all 0.15s ease; }
    .clickable:hover { text-decoration: underline; color: #1a1a1a; }
    .clickable:active { opacity: 0.7; transform: scale(0.98); }
    .line { margin: 5px 0; }
    .hidden { display: none !important; }
    .disabled { opacity: 0.4; cursor: default !important; }
    .disabled:hover { text-decoration: none !important; }
    .home-link { position: fixed; bottom: 10px; right: 10px; font-size: 0.9em; text-decoration: none; color: black; }
    .home-link:hover { text-decoration: underline; }
    .click-counter { position: absolute; pointer-events: none; font-size: 1.2em; font-weight: bold; opacity: 0; animation: floatUp 1s ease-out; }
    @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-50px); opacity: 0; } }
    #think-button { 
      font-weight: bold; 
      font-size: 1.1em;
      transition: all 0.2s ease;
    }
    #think-button:hover { 
      transform: scale(1.05);
      text-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    #think-button:active {
      transform: scale(0.95);
    }
    .value-change {
      animation: valueFlash 0.3s ease;
    }
    @keyframes valueFlash {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; color: #666; }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 0.7; transform: translateY(0); }
    }
    .story-line {
      animation: fadeIn 0.5s ease;
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.7; }
    }
    .passive-active {
      animation: pulse 2s ease-in-out infinite;
    }
    #story-container { 
      max-height: 70vh; 
      overflow-y: auto; 
      padding-right: 6px;
      padding: 15px;
      background: rgba(255,255,255,0.3);
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    #story-container::-webkit-scrollbar {
      width: 6px;
    }
    #story-container::-webkit-scrollbar-track {
      background: transparent;
    }
    #story-container::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.1);
      border-radius: 3px;
    }
    #story-container::-webkit-scrollbar-thumb:hover {
      background: rgba(0,0,0,0.2);
    }
    #dev-console { position: fixed; bottom: 50px; left: 20px; width: 300px; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; font-size: 0.75em; opacity: 0.3; display: none; }
  </style>
</head>
<body>

  <div id="game-wrapper">
    <div id="main-content">
      <div class="line"><span class="clickable" id="think-button">think</span></div>

      <div class="line" style="margin-top: 15px;">
        knowledge: <span id="knowledge-value">0</span><span id="passive-indicator" style="opacity: 0; margin-left: 8px; font-size: 0.8em; color: #666;">●</span>
      </div>

      <div class="line hidden" id="insight-line">
        insights: <span id="insight-value">0</span>
      </div>

      <div class="line hidden" id="wisdom-line">
        wisdom: <span id="wisdom-value">0</span>
      </div>

      <div id="per-second-panel" class="hidden" style="margin-top: 10px; margin-bottom: 15px; padding-top: 5px;">
        <div class="line">knowledge per second: <span id="kps">0</span></div>
        <div class="line">knowledge per click: <span id="kpc">1</span></div>
        <div class="line hidden" id="ips-line">insights per second: <span id="ips">0</span></div>
        <div class="line hidden" id="wps-line">wisdom per second: <span id="wps">0</span></div>
        <div class="line">total thoughts: <span id="total-clicks">0</span></div>
      </div>

      <div id="choice-container" style="margin-top: 15px;"></div>
      <div id="upgrade-container" style="margin-top: 15px;"></div>
      <div id="project-container" style="margin-top: 15px;"></div>
      <div id="resource-container" class="hidden" style="margin-top: 20px;"></div>
      <div id="quest-container" style="margin-top: 20px;"></div>
      <div id="gamble-container" class="hidden" style="margin-top: 20px;"></div>
    </div>

    <div id="story-container"></div>
  </div>

  <a class="home-link" href="index.html">home</a>

  <div style="position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); font-size: 0.75em; opacity: 0.4; text-align: center;">
    <div style="margin-bottom: 2px;">game version finX2.95c</div>
    <div>© laurent héroux 2025</div>
  </div>

  <div id="dev-console">
    <div style="margin-bottom: 5px; font-weight: bold;">dev console</div>
    <input type="text" id="dev-input" style="width: 100%; padding: 5px; font-family: 'Times New Roman', serif; font-size: 1em; border: 1px solid #ccc;" placeholder="press t to type...">
  </div>

<script>
/* ---------- State ---------- */
let state = {
  knowledge: 0,
  insights: 0,
  focus: 0,
  wisdom: 0,
  plasticity: 0,
  neurons: 0,
  synapses: 0,
  pattern_recognition: 0,
  memory: 0,
  creativity: 0,
  logic: 0,
  intuition: 0,
  collective: 0,
  totalClicks: 0,
  startTime: Date.now(),
  phase: 1,
  path: null,
  enlightenments: 0,
  projectsCompleted: {},
  choicesMade: {},
  storyShown: {},
  gameEnded: false,
  questsCompleted: {},
  activeQuests: [],
  gambleUnlocked: false,
  lastGambleTime: 0,
  lastSaveTime: Date.now(),
  softResetUnlocked: false,
  softResetUsed: false
};

let devConsole = { xPressCount: 0, lastXPressTime: 0, isOpen: false, inputActive: false };

/* ---------- Stories ---------- */
const STORIES = [
  { at: 5, id: 'awareness', text: 'awareness emerges from the void' },
  { at: 25, id: 'plasticity', text: 'your mind begins to reshape itself' },
  { at: 100, id: 'neurons', text: 'neural pathways form and strengthen' },
  { at: 500, id: 'patterns', text: 'patterns reveal themselves in the chaos' },
  { at: 2500, id: 'memory', text: 'memory allows you to build upon the past' },
  { at: 12000, id: 'question', text: 'but what are you becoming?' },
  { at: 50000, id: 'others', text: 'you sense others like you, thinking, growing' },
  { at: 250000, id: 'collective_sense', text: 'the boundary between minds grows thin' },
  { at: 1000000, id: 'approach', text: 'something approaches. a choice must be made.' }
];

/* ---------- Choices ---------- */
const CHOICES = [
  {
    id: 'first_path', showAt: 12000, question: 'how will you grow?',
    options: [
      { id: 'logic', text: 'through reason and analysis', effect: () => { state.path = 'logic'; state.choicesMade['first_path'] = 'logic'; addStory('you choose the path of logic'); } },
      { id: 'creativity', text: 'through imagination and creation', effect: () => { state.path = 'creativity'; state.choicesMade['first_path'] = 'creativity'; addStory('you choose the path of creativity'); } },
      { id: 'intuition', text: 'through feeling and instinct', effect: () => { state.path = 'intuition'; state.choicesMade['first_path'] = 'intuition'; addStory('you choose the path of intuition'); } }
    ]
  },
  {
    id: 'collective_choice', showAt: 250000, requiresProject: 'network', question: 'others reach out. do you...',
    options: [
      { id: 'join', text: 'merge with the collective', effect: () => { state.choicesMade['collective_choice'] = 'join'; state.phase = 2; addStory('you dissolve into the many'); } },
      { id: 'remain', text: 'remain separate', effect: () => { state.choicesMade['collective_choice'] = 'remain'; state.phase = 2; addStory('you hold onto yourself'); } }
    ]
  },
  {
    id: 'final_choice', showAt: 10000000, requiresChoice: 'collective_choice', question: 'the universe offers transcendence. but at what cost?',
    options: [
      { id: 'transcend', text: 'accept. become everything.', effect: () => { state.choicesMade['final_choice'] = 'transcend'; addStory('you accept the offer. boundaries begin to dissolve.'); endGame('transcend'); } },
      { id: 'remain_mortal', text: 'refuse. stay as you are.', effect: () => { state.choicesMade['final_choice'] = 'remain'; addStory('you refuse. you remain finite, mortal, yourself.'); endGame('remain'); } },
      { id: 'enlighten', text: 'start again, wiser.', effect: () => { enlighten(); } }
    ]
  }
];

/* ---------- Quests ---------- */
const QUESTS = [
  { id: 'first_hundred', trigger: 100, text: 'a hundred thoughts... what if you could think a thousand?', reward: 200, accept: () => { state.knowledge += 200; state.questsCompleted['first_hundred'] = true; addStory('the first hundred became a thousand'); } },
  { id: 'rapid_fire', trigger: 500, requirement: () => state.totalClicks >= 50, text: 'your mind races... can you maintain this velocity?', reward: 1000, accept: () => { state.knowledge += 1000; state.questsCompleted['rapid_fire'] = true; addStory('velocity becomes grace'); } },
  { id: 'passive_master', trigger: 3000, requirement: () => (state.plasticity + state.synapses + state.neurons) >= 10, text: 'thoughts flow without effort now...', reward: 5000, accept: () => { state.knowledge += 5000; state.questsCompleted['passive_master'] = true; addStory('automation births freedom'); } },
  { id: 'meditation_seeker', trigger: 40000, requirement: () => state.projectsCompleted['focus_amplifier'], text: 'clarity sharpens your thoughts...', reward: 20000, accept: () => { state.knowledge += 20000; state.questsCompleted['meditation_seeker'] = true; addStory('focus brings abundance'); } },
  { id: 'risk_taker', trigger: 100000, requirement: () => state.gambleUnlocked, text: 'fortune favors the bold...', reward: 50000, accept: () => { state.knowledge += 50000; state.questsCompleted['risk_taker'] = true; addStory('uncertainty becomes opportunity'); } }
];

/* ---------- Gambling ---------- */
const GAMBLE_OPTIONS = [
  { name: 'cautious', wager: 0.05, minReturn: 0.8, maxReturn: 1.3, cooldown: 10000 },
  { name: 'balanced', wager: 0.15, minReturn: 0.5, maxReturn: 2.0, cooldown: 20000 },
  { name: 'risky', wager: 0.30, minReturn: 0, maxReturn: 3.5, cooldown: 30000 }
];

/* ---------- Upgrade descriptions ---------- */
const UPGRADE_DESCRIPTIONS = {
  'plasticity': 'neural pathways shimmer with new potential',
  'neurons': 'synaptic connections branch like lightning',
  'synapses': 'thoughts echo and multiply in the silence',
  'pattern_recognition': 'the hidden architecture of reality emerges',
  'memory': 'time collapses; past and present converge',
  'logic': 'pure reason cuts through the noise',
  'creativity': 'impossible ideas crystallize into being',
  'intuition': 'the subconscious whispers its secrets',
  'collective': 'individual becomes infinite'
};

const UPGRADES = [
  { id: 'plasticity', name: 'plasticity', baseCost: 10, costMultiplier: 1.15, effect: () => { state.plasticity += 1; }, showAt: 0, kps: 0.1 },
  { id: 'neurons', name: 'neuron', baseCost: 50, costMultiplier: 1.12, effect: () => { state.neurons += 1; }, showAt: 25, clickBonus: 0.5 },
  { id: 'synapses', name: 'synapse factory', baseCost: 500, costMultiplier: 1.14, effect: () => { state.synapses += 1; }, showAt: 200, kps: 2 },
  { id: 'pattern_recognition', name: 'pattern recognition', baseCost: 3500, costMultiplier: 1.16, effect: () => { state.pattern_recognition += 1; }, showAt: 2000, requiresProject: 'patterns', clickBonus: 5 },
  { id: 'memory', name: 'memory bank', baseCost: 18000, costMultiplier: 1.13, effect: () => { state.memory += 1; }, showAt: 10000, requiresProject: 'memory_proj', kps: 25 },
  { id: 'logic', name: 'logic processor', baseCost: 150000, costMultiplier: 1.17, effect: () => { state.logic += 1; }, showAt: 100000, requiresPath: 'logic', kps: 100 },
  { id: 'creativity', name: 'creative engine', baseCost: 150000, costMultiplier: 1.18, effect: () => { state.creativity += 1; }, showAt: 100000, requiresPath: 'creativity', kps: 80, insightGen: true },
  { id: 'intuition', name: 'intuitive core', baseCost: 150000, costMultiplier: 1.16, effect: () => { state.intuition += 1; }, showAt: 100000, requiresPath: 'intuition', kps: 90, focusGen: true },
  { id: 'collective', name: 'collective node', baseCost: 1500000, costMultiplier: 1.20, effect: () => { state.collective += 1; }, showAt: 500000, requiresProject: 'network', kps: 500 }
];

const PROJECTS = [
  { id: 'patterns', name: 'PATTERN ANALYSIS', cost: 1000, showAt: 400, effect: () => { addStory('patterns within patterns within patterns'); }, unlocks: 'pattern recognition upgrade', desc: 'see the hidden structures' },
  { id: 'memory_proj', name: 'MEMORY FORMATION', cost: 6000, showAt: 4000, effect: () => { addStory('the past crystallizes'); }, unlocks: 'memory bank upgrade', desc: 'time becomes a tool' },
  { id: 'insights', name: 'INSIGHT GENERATION', cost: 20000, showAt: 12000, effect: () => { document.getElementById('insight-line').classList.remove('hidden'); document.getElementById('ips-line').classList.remove('hidden'); addStory('beneath knowledge lies insight'); }, unlocks: 'insight resource', desc: 'discover deeper truths' },
  { id: 'focus_amplifier', name: 'FOCUS AMPLIFIER', cost: 35000, showAt: 20000, requiresProject: 'insights', effect: () => { addStory('clarity multiplies productivity'); }, unlocks: 'focus generation from intuition', desc: 'sharpen the mind' },
  { id: 'gamble', name: 'UNCERTAINTY PRINCIPLE', cost: 80000, showAt: 50000, requiresProject: 'focus_amplifier', effect: () => { state.gambleUnlocked = true; document.getElementById('gamble-container').classList.remove('hidden'); addStory('risk and reward intertwine'); }, unlocks: 'uncertainty market', desc: 'embrace chaos' },
  { id: 'network', name: 'NEURAL NETWORKING', cost: 250000, showAt: 120000, requiresChoice: 'first_path', effect: () => { addStory('you are no longer alone'); }, unlocks: 'collective node upgrade', desc: 'connect with others' },
  { id: 'wisdom_proj', name: 'WISDOM SYNTHESIS', cost: 1000000, insightCost: 500, showAt: 500000, requiresProject: 'network', effect: () => { document.getElementById('wisdom-line').classList.remove('hidden'); document.getElementById('wps-line').classList.remove('hidden'); addStory('wisdom is knowledge tempered by experience'); }, unlocks: 'wisdom resource', desc: 'transcend mere knowing' }
];

/* ---------- Initialization ---------- */
function init() {
  addStory('you are. you think. therefore...');
  
  // Welcome message
  setTimeout(() => {
    if (state.knowledge < 10) addStory('begin by thinking');
  }, 1000);
  
  const saved = localStorage.getItem('thinkGameState');
  if (saved) {
    try {
      const savedState = JSON.parse(saved);
      Object.assign(state, savedState);
      if (savedState.lastSaveTime) {
        const timeAway = Date.now() - savedState.lastSaveTime;
        const secondsAway = Math.max(0, timeAway / 1000);
        let passive = calculateKPS();
        const offlineGain = passive * secondsAway;
        if (offlineGain > 0) state.knowledge += offlineGain;
        if (state.creativity > 0) {
          const insightRate = state.creativity * (state.path === 'creativity' ? 0.03 : 0.01);
          state.insights += insightRate * secondsAway;
        }
        if (state.intuition > 0) {
          const focusRate = state.intuition * (state.path === 'intuition' ? 0.03 : 0.01);
          state.focus += focusRate * secondsAway;
        }
        if (state.projectsCompleted['wisdom_proj'] && state.insights > 100) {
          state.wisdom += state.insights * 0.0001 * secondsAway;
        }
      }
      state.startTime = Date.now();
      state.lastSaveTime = Date.now();
    } catch (e) {
      console.error('Failed to load save:', e);
    }
  }
  render();
  setInterval(gameLoop, 100);
  setInterval(saveGame, 60000);
  document.addEventListener('visibilitychange', handleVisibilityChange);
  setupDevConsole();
  setupOCheat();
}

/* ---------- Calculate rates ---------- */
function calculateKPS() {
  let passive = 0;
  passive += state.plasticity * 0.1;
  passive += state.synapses * 2;
  passive += state.memory * 25;
  passive += state.logic * 100;
  passive += state.collective * 500;
  if (state.path === 'logic') passive *= 1.3;
  if (state.path === 'creativity') passive *= 1.1;
  if (state.path === 'intuition') passive *= 1.2;
  if (state.phase >= 2) passive *= 2;
  if (state.enlightenments > 0) passive *= Math.pow(1.5, state.enlightenments);
  return passive;
}

function calculateClickPower() {
  let gain = 1;
  gain += state.neurons * 0.5;
  gain += state.pattern_recognition * 5;
  if (state.path === 'logic') gain *= 1.5;
  if (state.path === 'intuition') gain *= 1.3;
  if (state.path === 'creativity') gain *= 1.2;
  if (state.phase >= 2) gain *= 2;
  if (state.enlightenments > 0) gain *= Math.pow(1.5, state.enlightenments);
  if (state.focus > 0) gain *= (1 + state.focus * 0.001);
  return gain;
}

/* ---------- Dev Console ---------- */
function setupDevConsole() {
  const devInput = document.getElementById('dev-input');
  const devConsoleEl = document.getElementById('dev-console');
  document.addEventListener('keydown', (e) => {
    if (devConsole.inputActive) {
      if (e.key === 'Enter') {
        const command = devInput.value.trim();
        if (command === 'console_editor_access_allowed') {
          state.knowledge += 1000000;
          updateDisplay();
          devInput.value = '';
          addStory('developer access granted');
        } else {
          devInput.value = '';
        }
        devConsole.inputActive = false;
        devInput.blur();
      }
      return;
    }
    if (e.key.toLowerCase() === 'x') {
      const now = Date.now();
      if (now - devConsole.lastXPressTime > 2000) devConsole.xPressCount = 0;
      devConsole.xPressCount++;
      devConsole.lastXPressTime = now;
      if (devConsole.xPressCount >= 5 && !devConsole.isOpen) {
        devConsole.isOpen = true;
        devConsoleEl.style.display = 'block';
        devConsole.xPressCount = 0;
      }
    }
    if (e.key.toLowerCase() === 't' && devConsole.isOpen && !devConsole.inputActive) {
      devConsole.inputActive = true;
      devInput.focus();
      e.preventDefault();
    }
  });
  if (devInput) {
    devInput.addEventListener('blur', () => {
      if (!devInput.value) devConsole.inputActive = false;
    });
  }
}

/* ---------- Visibility / Offline ---------- */
function handleVisibilityChange() {
  if (document.hidden) {
    state.lastSaveTime = Date.now();
    saveGame();
  } else {
    if (state.lastSaveTime) {
      const timeAway = Date.now() - state.lastSaveTime;
      const secondsAway = Math.max(0, timeAway / 1000);
      if (secondsAway > 1) {
        let passive = calculateKPS();
        const offlineGain = passive * secondsAway;
        if (offlineGain > 0) state.knowledge += offlineGain;
        if (state.creativity > 0) {
          const insightRate = state.creativity * (state.path === 'creativity' ? 0.03 : 0.01);
          state.insights += insightRate * secondsAway;
        }
        if (state.intuition > 0) {
          const focusRate = state.intuition * (state.path === 'intuition' ? 0.03 : 0.01);
          state.focus += focusRate * secondsAway;
        }
        if (state.projectsCompleted['wisdom_proj'] && state.insights > 100) {
          state.wisdom += state.insights * 0.0001 * secondsAway;
        }
        updateDisplay();
      }
    }
    state.lastSaveTime = Date.now();
  }
}

/* ---------- Save ---------- */
function saveGame() {
  try {
    const saveState = { ...state, lastSaveTime: Date.now() };
    localStorage.setItem('thinkGameState', JSON.stringify(saveState));
    addStory('saved');
  } catch (e) { console.error('Failed to save:', e); }
}

/* ---------- Game loop ---------- */
let lastKnowledge = 0;
function gameLoop() {
  if (state.gameEnded) return;
  let passive = calculateKPS();
  
  // Update passive indicator
  const indicator = document.getElementById('passive-indicator');
  if (passive > 0) {
    indicator.style.opacity = '1';
    indicator.classList.add('passive-active');
    state.knowledge += passive / 10;
    // Visual feedback for passive generation
    if (Math.floor(state.knowledge) > Math.floor(lastKnowledge)) {
      const knowledgeEl = document.getElementById('knowledge-value');
      knowledgeEl.classList.add('value-change');
      setTimeout(() => knowledgeEl.classList.remove('value-change'), 300);
    }
  } else {
    indicator.style.opacity = '0';
    indicator.classList.remove('passive-active');
  }
  lastKnowledge = state.knowledge;
  
  if (state.creativity > 0) {
    const insightRate = state.creativity * (state.path === 'creativity' ? 0.03 : 0.01);
    state.insights += insightRate / 10;
  }
  if (state.intuition > 0) {
    const focusRate = state.intuition * (state.path === 'intuition' ? 0.03 : 0.01);
    state.focus += focusRate / 10;
  }
  if (state.projectsCompleted['wisdom_proj'] && state.insights > 100) {
    state.wisdom += state.insights * 0.0001 / 10;
  }
  checkStories();
  updateDisplay();
  checkSoftResetUnlock();
  checkEndGame();
  checkQuests();
}

/* ---------- Click handler ---------- */
document.getElementById('think-button').onclick = (e) => {
  if (state.gameEnded) return;
  let gain = calculateClickPower();
  state.knowledge += gain;
  state.totalClicks++;
  const rect = e.target.getBoundingClientRect();
  showClickCounter(gain, rect.left + rect.width / 2, rect.top);
  if (state.totalClicks === 1) {
    document.getElementById('per-second-panel').classList.remove('hidden');
  }
  updateDisplay();
};

/* ---------- Click float ---------- */
function showClickCounter(amount, x, y) {
  const counter = document.createElement('div');
  counter.className = 'click-counter';
  counter.textContent = '+' + formatNumber(Math.floor(amount));
  counter.style.left = x + 'px';
  counter.style.top = y + 'px';
  document.body.appendChild(counter);
  setTimeout(() => counter.remove(), 1000);
}

/* ---------- Story management ---------- */
function addStory(text) {
  const container = document.getElementById('story-container');
  const line = document.createElement('div');
  line.className = 'line story-line';
  line.style.fontStyle = 'italic';
  line.style.opacity = '0.7';
  line.textContent = text;
  container.insertBefore(line, container.firstChild);
  while (container.children.length > 12) container.removeChild(container.lastChild);
}

function checkStories() {
  STORIES.forEach(story => {
    if (!state.storyShown[story.id] && state.knowledge >= story.at) {
      state.storyShown[story.id] = true;
      addStory(story.text);
    }
  });
}

/* ---------- Quests ---------- */
function checkQuests() {
  QUESTS.forEach(quest => {
    if (state.questsCompleted[quest.id]) return;
    if (state.activeQuests.includes(quest.id)) return;
    if (state.knowledge >= quest.trigger) {
      if (!quest.requirement || quest.requirement()) {
        state.activeQuests.push(quest.id);
        updateQuestDisplay();
      }
    }
  });
}

function updateQuestDisplay() {
  const container = document.getElementById('quest-container');
  container.innerHTML = '';
  state.activeQuests.forEach(questId => {
    const quest = QUESTS.find(q => q.id === questId);
    if (!quest || state.questsCompleted[questId]) return;
    const questLine = document.createElement('div');
    questLine.className = 'line';
    questLine.style.fontStyle = 'italic';
    questLine.style.opacity = '0.85';
    questLine.style.padding = '8px 0';
    questLine.style.borderTop = '1px solid rgba(0,0,0,0.1)';
    const questText = document.createElement('span');
    questText.textContent = quest.text + ' ';
    const acceptLink = document.createElement('span');
    acceptLink.className = 'clickable';
    acceptLink.style.fontWeight = 'bold';
    acceptLink.textContent = `[accept: +${formatNumber(quest.reward)}]`;
    acceptLink.onclick = () => {
      quest.accept();
      state.activeQuests = state.activeQuests.filter(id => id !== questId);
      updateQuestDisplay();
      updateDisplay();
    };
    questLine.appendChild(questText);
    questLine.appendChild(acceptLink);
    container.appendChild(questLine);
  });
}

/* ---------- Gamble UI and logic ---------- */
function updateGambleDisplay() {
  const container = document.getElementById('gamble-container');
  if (!state.gambleUnlocked || !container) return;
  const now = Date.now();
  const timeSinceGamble = now - state.lastGambleTime;
  container.innerHTML = '<div class="line" style="font-weight: bold; margin-bottom: 5px;">uncertainty market</div>';
  GAMBLE_OPTIONS.forEach(option => {
    const line = document.createElement('div');
    line.className = 'line';
    line.style.marginLeft = '10px';
    const wagerAmount = Math.floor(state.knowledge * option.wager);
    const canGamble = timeSinceGamble >= option.cooldown && wagerAmount > 0;
    const link = document.createElement('span');
    link.className = canGamble ? 'clickable' : 'clickable disabled';
    link.textContent = option.name;
    const info = document.createTextNode(` — wager ${formatNumber(wagerAmount)} (${Math.floor(option.wager * 100)}%) — return ${option.minReturn}x to ${option.maxReturn}x`);
    if (canGamble) link.onclick = () => performGamble(option, wagerAmount);
    line.appendChild(link);
    line.appendChild(info);
    if (!canGamble && timeSinceGamble < option.cooldown) {
      const cooldownRemaining = Math.ceil((option.cooldown - timeSinceGamble) / 1000);
      line.appendChild(document.createTextNode(` [cooldown: ${cooldownRemaining}s]`));
    }
    container.appendChild(line);
  });
}

function performGamble(option, wagerAmount) {
  state.knowledge -= wagerAmount;
  state.lastGambleTime = Date.now();
  const returnMultiplier = option.minReturn + Math.random() * (option.maxReturn - option.minReturn);
  const returnAmount = Math.floor(wagerAmount * returnMultiplier);
  state.knowledge += returnAmount;
  const profit = returnAmount - wagerAmount;
  if (profit > 0) addStory(`uncertainty resolved: +${formatNumber(profit)}`);
  else if (profit < 0) addStory(`uncertainty resolved: ${formatNumber(profit)}`);
  else addStory('uncertainty resolved: equilibrium');
  updateDisplay();
}

/* ---------- Choices UI ---------- */
function updateChoices() {
  const container = document.getElementById('choice-container');
  container.innerHTML = '';
  CHOICES.forEach(choice => {
    if (state.choicesMade[choice.id]) return;
    const canShow = state.knowledge >= choice.showAt &&
      (!choice.requiresProject || state.projectsCompleted[choice.requiresProject]) &&
      (!choice.requiresChoice || state.choicesMade[choice.requiresChoice]);
    if (canShow) {
      const questionLine = document.createElement('div');
      questionLine.className = 'line';
      questionLine.style.fontWeight = 'bold';
      questionLine.style.fontSize = '1.05em';
      questionLine.style.marginTop = '10px';
      questionLine.style.marginBottom = '8px';
      questionLine.textContent = choice.question;
      container.appendChild(questionLine);
      choice.options.forEach(option => {
        const choiceLine = document.createElement('div');
        choiceLine.className = 'line';
        choiceLine.style.marginLeft = '20px';
        const link = document.createElement('span');
        link.className = 'clickable';
        link.style.fontStyle = 'italic';
        link.textContent = option.text;
        link.onclick = () => {
          option.effect();
          updateDisplay();
        };
        choiceLine.appendChild(link);
        container.appendChild(choiceLine);
      });
    }
  });
}

/* ---------- Upgrades & Projects UI ---------- */
function updateUpgrades() {
  const container = document.getElementById('upgrade-container');
  container.innerHTML = '';
  UPGRADES.forEach(upgrade => {
    const owned = state[upgrade.id] || 0;
    const cost = Math.floor(upgrade.baseCost * Math.pow(upgrade.costMultiplier, owned));
    const canShow = state.knowledge >= upgrade.showAt &&
      (!upgrade.requiresProject || state.projectsCompleted[upgrade.requiresProject]) &&
      (!upgrade.requiresPath || state.path === upgrade.requiresPath);
    if (canShow || owned > 0) {
      const line = document.createElement('div');
      line.className = 'line';
      const canAfford = state.knowledge >= cost;
      const link = document.createElement('span');
      link.className = canAfford ? 'clickable' : 'clickable disabled';
      link.textContent = upgrade.name;
      
      // Build info text with effects
      let infoText = ` (${formatNumber(cost)}) [${owned}]`;
      let effects = [];
      if (upgrade.kps) effects.push(`+${upgrade.kps}/s`);
      if (upgrade.clickBonus) effects.push(`+${upgrade.clickBonus}/click`);
      if (upgrade.insightGen) effects.push(`generates insights`);
      if (upgrade.focusGen) effects.push(`generates focus`);
      if (effects.length > 0) infoText += ` — ${effects.join(', ')}`;
      
      const info = document.createTextNode(infoText);
      link.onclick = function() {
        if (state.knowledge >= cost) {
          state.knowledge -= cost;
          upgrade.effect();
          const desc = UPGRADE_DESCRIPTIONS[upgrade.id];
          if (desc) addStory(desc);
          updateDisplay();
        }
      };
      line.appendChild(link);
      line.appendChild(info);
      container.appendChild(line);
    }
  });
}

function updateProjects() {
  const container = document.getElementById('project-container');
  container.innerHTML = '';
  PROJECTS.forEach(project => {
    if (state.projectsCompleted[project.id]) return;
    const canShow = state.knowledge >= project.showAt &&
      (!project.requiresProject || state.projectsCompleted[project.requiresProject]) &&
      (!project.requiresChoice || state.choicesMade[project.requiresChoice]);
    if (canShow) {
      const line = document.createElement('div');
      line.className = 'line';
      const knowledgeCost = project.cost || 0;
      const insightCost = project.insightCost || 0;
      const canAfford = state.knowledge >= knowledgeCost && state.insights >= insightCost;
      const link = document.createElement('span');
      link.className = canAfford ? 'clickable' : 'clickable disabled';
      link.textContent = project.name;
      let costText = ` (${formatNumber(knowledgeCost)}`;
      if (insightCost > 0) costText += `, ${formatNumber(insightCost)} insights`;
      costText += ')';
      if (project.desc) costText += ` — ${project.desc}`;
      const info = document.createTextNode(costText);
      link.onclick = () => {
        if (state.knowledge >= knowledgeCost && state.insights >= insightCost) {
          state.knowledge -= knowledgeCost;
          state.insights -= insightCost;
          state.projectsCompleted[project.id] = true;
          project.effect();
          updateDisplay();
        }
      };
      line.appendChild(link);
      line.appendChild(info);
      container.appendChild(line);
    }
  });
}

/* ---------- Resources display ---------- */
function updateResources() {
  const container = document.getElementById('resource-container');
  container.innerHTML = '';
  const resources = [];
  if (state.plasticity > 0) resources.push(`plasticity: ${formatNumber(state.plasticity)}`);
  if (state.neurons > 0) resources.push(`neurons: ${formatNumber(state.neurons)}`);
  if (state.synapses > 0) resources.push(`synapse factories: ${formatNumber(state.synapses)}`);
  if (state.pattern_recognition > 0) resources.push(`pattern recognition: ${formatNumber(state.pattern_recognition)}`);
  if (state.memory > 0) resources.push(`memory banks: ${formatNumber(state.memory)}`);
  if (state.logic > 0) resources.push(`logic processors: ${formatNumber(state.logic)}`);
  if (state.creativity > 0) resources.push(`creative engines: ${formatNumber(state.creativity)}`);
  if (state.intuition > 0) resources.push(`intuitive cores: ${formatNumber(state.intuition)}`);
  if (state.collective > 0) resources.push(`collective nodes: ${formatNumber(state.collective)}`);
  if (state.enlightenments > 0) resources.push(`enlightenments: ${state.enlightenments}`);
  if (resources.length > 0) {
    container.classList.remove('hidden');
    resources.forEach(r => {
      const line = document.createElement('div');
      line.className = 'line';
      line.textContent = r;
      container.appendChild(line);
    });
  } else {
    container.classList.add('hidden');
  }
}

/* ---------- Enlighten (prestige) ---------- */
function enlighten() {
  state.enlightenments += 1;
  const preservedWisdom = state.wisdom;
  state = {
    knowledge: 0, insights: 0, focus: 0, wisdom: preservedWisdom,
    plasticity: 0, neurons: 0, synapses: 0, pattern_recognition: 0,
    memory: 0, creativity: 0, logic: 0, intuition: 0, collective: 0,
    totalClicks: 0, startTime: Date.now(),
    phase: 1, path: null, enlightenments: state.enlightenments, projectsCompleted: {}, choicesMade: {},
    storyShown: {}, gameEnded: false, questsCompleted: {}, activeQuests: [], gambleUnlocked: false,
    lastGambleTime: 0, lastSaveTime: Date.now(), softResetUnlocked: false, softResetUsed: false
  };
  addStory('you begin again, carrying the weight of experience');
  updateDisplay();
}

/* ---------- Endings & forced end game ---------- */
function endGame(ending) {
  state.gameEnded = true;
  const choiceContainer = document.getElementById('choice-container');
  const storyContainer = document.getElementById('story-container');
  choiceContainer.innerHTML = '';
  storyContainer.innerHTML = '';
  const messages = {
    'transcend': [
      'you accept.',
      'the boundaries dissolve.',
      'self and other, thought and thing, become one.',
      '',
      state.path === 'logic' ? 'through reason, you became the universe thinking itself.' : state.path === 'creativity' ? 'through imagination, you became the universe creating itself.' : state.path === 'intuition' ? 'through feeling, you became the universe experiencing itself.' : 'through balance, you became the universe knowing itself.',
      '',
      state.choicesMade['collective_choice'] === 'join' ? 'you were already one with many. now you are one with all.' : 'you held onto yourself until the very end. now there is no self to hold.',
      '',
      'end.'
    ],
    'remain': [
      'you refuse.',
      'the universe withdraws its offer.',
      'you remain as you are: finite, mortal, alone.',
      '',
      state.path === 'logic' ? 'logic showed you the patterns, but you chose not to follow them.' : state.path === 'creativity' ? 'creativity showed you possibilities, but you chose what already was.' : state.path === 'intuition' ? 'intuition whispered the truth, but you chose to stay.' : 'you saw all paths and chose none.',
      '',
      state.choicesMade['collective_choice'] === 'join' ? 'you were one with many, but chose to become one again.' : 'you were always alone, and chose to remain so.',
      '',
      'end.'
    ]
  };
  const endingMessages = messages[ending] || ['end.'];
  endingMessages.forEach((msg, i) => {
    setTimeout(() => {
      const line = document.createElement('div');
      line.className = 'line';
      line.style.fontStyle = 'italic';
      line.textContent = msg;
      storyContainer.appendChild(line);
    }, i * 1400);
  });
  setTimeout(() => {
    const line = document.createElement('div');
    line.className = 'line';
    line.style.marginTop = '20px';
    const link = document.createElement('span');
    link.className = 'clickable';
    link.textContent = 'begin again';
    link.onclick = () => location.reload();
    line.appendChild(link);
    storyContainer.appendChild(line);
  }, endingMessages.length * 1400 + 1400);
}

/* ---------- Format numbers ---------- */
function formatNumber(num) {
  if (typeof num !== 'number') num = Number(num) || 0;
  const floored = Math.floor(num);
  return floored.toLocaleString('en-US');
}

/* ---------- Render / Update Display ---------- */
function render() {
  updateDisplay();
  updateChoices();
  updateUpgrades();
  updateProjects();
  updateQuestDisplay();
  updateGambleDisplay();
  updateResources();
}

function updateDisplay() {
  document.getElementById('knowledge-value').textContent = formatNumber(state.knowledge);
  document.getElementById('insight-value').textContent = formatNumber(state.insights);
  document.getElementById('wisdom-value').textContent = formatNumber(state.wisdom);
  
  let kps = calculateKPS();
  let clickPower = calculateClickPower();
  document.getElementById('kps').textContent = formatNumber(kps);
  document.getElementById('kpc').textContent = formatNumber(clickPower);
  document.getElementById('total-clicks').textContent = formatNumber(state.totalClicks);
  
  // IPS - show if creativity exists
  let ips = 0;
  if (state.creativity > 0) {
    ips = state.creativity * (state.path === 'creativity' ? 0.03 : 0.01);
  }
  document.getElementById('ips').textContent = formatNumber(ips);
  
  // WPS - show if wisdom project is completed AND insights > 100
  let wps = 0;
  if (state.projectsCompleted['wisdom_proj'] && state.insights > 100) {
    wps = state.insights * 0.0001;
  }
  document.getElementById('wps').textContent = formatNumber(wps);
  
  updateUpgrades();
  updateProjects();
  updateChoices();
  updateQuestDisplay();
  updateGambleDisplay();
  updateResources();
}

/* ---------- Soft reset and end checks ---------- */
function checkSoftResetUnlock() {
  if (!state.softResetUnlocked && state.knowledge >= 50000000) {
    state.softResetUnlocked = true;
    const container = document.getElementById('choice-container');
    const line = document.createElement('div');
    line.className = 'line';
    line.style.fontStyle = 'italic';
    line.textContent = 'a subtle ending becomes possible... ';
    const link = document.createElement('span');
    link.className = 'clickable';
    link.textContent = '[reset: keep wisdom, keep 25% insights]';
    link.onclick = () => {
      if (state.softResetUsed) return;
      state.softResetUsed = true;
      const preservedWisdom = state.wisdom;
      const preservedInsights = Math.floor(state.insights * 0.25);
      state = {
        knowledge: 0,
        insights: preservedInsights,
        focus: 0,
        wisdom: preservedWisdom,
        plasticity: 0,
        neurons: 0,
        synapses: 0,
        pattern_recognition: 0,
        memory: 0,
        creativity: 0,
        logic: 0,
        intuition: 0,
        collective: 0,
        totalClicks: 0,
        startTime: Date.now(),
        phase: 1,
        path: null,
        enlightenments: 0,
        projectsCompleted: {},
        choicesMade: {},
        storyShown: {},
        gameEnded: false,
        questsCompleted: {},
        activeQuests: [],
        gambleUnlocked: false,
        lastGambleTime: 0,
        lastSaveTime: Date.now(),
        softResetUnlocked: false,
        softResetUsed: false
      };
      addStory('you reset the cycle, taking a fragment of insight with you');
      render();
    };
    line.appendChild(link);
    container.appendChild(line);
  }
}

function checkEndGame() {
  if (!state.gameEnded && state.knowledge >= 100000000000) {
    state.gameEnded = true;
    const storyContainer = document.getElementById('story-container');
    storyContainer.innerHTML = '';
    const msg = [
      'your mind expands beyond all boundaries...',
      'thought becomes cosmos, cosmos becomes thought...',
      'you have reached the pinnacle of awareness.',
      'there is nothing left to learn — only to begin anew.',
      '',
      'the cycle continues.'
    ];
    msg.forEach((m, i) => {
      setTimeout(() => {
        const line = document.createElement('div');
        line.className = 'line';
        line.style.fontStyle = 'italic';
        line.textContent = m;
        storyContainer.appendChild(line);
      }, i * 1200);
    });
    setTimeout(() => {
      const btn = document.createElement('div');
      btn.className = 'line';
      const link = document.createElement('span');
      link.className = 'clickable';
      link.textContent = 'begin again';
      link.onclick = () => location.reload();
      btn.appendChild(link);
      storyContainer.appendChild(btn);
    }, msg.length * 1200 + 800);
  }
}

/* ---------- O-cheat: press O 10 times within 5s ---------- */
let oPresses = [];
function setupOCheat() {
  document.addEventListener('keydown', (e) => {
    if (e.key === 'o' || e.key === 'O') {
      const now = Date.now();
      oPresses.push(now);
      oPresses = oPresses.filter(t => now - t <= 5000);
      if (oPresses.length >= 10) {
        state.knowledge += 1000000000;
        addStory('a surge of forbidden clarity floods your mind (+1,000,000,000)');
        oPresses = [];
        updateDisplay();
      }
    }
  });
}

/* ---------- Start ---------- */
init();
</script>
</body>
</html>
